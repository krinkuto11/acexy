services:
  acexy:
    image: ghcr.io/javinator9889/acexy:0.2.0
    restart: unless-stopped
    ports:
      - 8080:8080/tcp
    environment:
      ACEXY_ADDR: ":8080"            # Listen on port 8080
      ACEXY_SCHEME: "http"           # Use HTTP
      ACEXY_HOST: "127.0.0.1"        # Fallback host when orchestrator not available
      ACEXY_PORT: "6878"             # Fallback port when orchestrator not available
      ACEXY_TIMEOUT: "60s"           # Stream timeout when in M3U8 mode
      ACEXY_M3U8: "false"            # Disable M3U8 mode
      ACEXY_EMPTY_TIMEOUT: "60s"     # Timeout to close the connection if no data is received
      ACEXY_BUFFER: "4MB"            # Buffer size is 4MB
      ACEXY_NO_RESPONSE_TIMEOUT: "10s"  # Timeout to close the connection if no response is received
      # Orchestrator integration (enabled by default)
      ACEXY_ORCH_URL: "http://orchestrator:8000"     # Base URL for orchestrator API 
      ACEXY_ORCH_APIKEY: ""        # API key for orchestrator authentication (set in .env if needed)
      # ACEXY_CONTAINER_ID: ""       # Container ID for orchestrator identification (auto-detected if empty)
    depends_on:
      - orchestrator

  orchestrator:
    build: ./acestream-orchestrator-main
    volumes:
      - orchestrator-db:/app
      - /var/run/docker.sock:/var/run/docker.sock  # Direct Docker socket access for container management
    ports:
      - "8000:8000"
    environment:
      APP_PORT: 8000
      TARGET_IMAGE: "martinbjeldbak/acestream-http-proxy:latest"
      MIN_REPLICAS: 0
      MAX_REPLICAS: 10
      CONTAINER_LABEL: "orchestrator.managed=acestream"
      STARTUP_TIMEOUT_S: 30
      IDLE_TTL_S: 600
      PORT_RANGE_HOST: "19000-19999"
      # Set AUTO_DELETE=true to automatically clean up idle containers
      AUTO_DELETE: "true"
    restart: on-failure

volumes:
  orchestrator-db:
