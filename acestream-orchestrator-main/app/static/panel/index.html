<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orchestrator Panel</title>
  <style>
    :root{color-scheme:dark;}
    body{margin:0;background:#0a0a0a;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header,section{padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid #222}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,button{background:#111;border:1px solid #333;color:#eaeaea;border-radius:6px;padding:8px}
    button{cursor:pointer}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{border:1px solid #222;border-radius:10px;padding:12px;background:#0f0f0f}
    .list{display:grid;gap:8px}
    .item{border:1px solid #222;border-radius:8px;padding:10px;background:#0e0e0e;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .muted{opacity:.7;font-size:.9em}
    a{color:#6aa9ff}
    .error{border:1px solid #611;background:#2a0000;color:#ffb4ae;padding:8px;border-radius:8px}
    .row{display:flex;gap:10px;align-items:center}
    .btn{padding:6px 10px;border:1px solid #333;border-radius:8px;background:#131313}
    .btn.red{border-color:#652a2a;background:#2a0000}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center"><strong>Orchestrator Panel</strong><span class="muted" id="status">ok</span></div>
    <div class="controls">
      <input id="orch" placeholder="http://localhost:8000" title="Orchestrator base URL" />
      <input id="apikey" placeholder="API key (Bearer)" title="API key for Authorization" />
      <select id="interval" title="Refresh interval">
        <option value="2000">2s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
      </select>
      <button id="refresh" class="btn">Refresh</button>
    </div>
  </header>

  <section class="grid g3">
    <div class="card"><div class="muted">Engines</div><div id="kpi-engines" style="font-size:28px;font-weight:700">0</div></div>
    <div class="card"><div class="muted">Streams</div><div id="kpi-streams" style="font-size:28px;font-weight:700">0</div></div>
    <div class="card"><div class="muted">Last update</div><div id="kpi-upd" style="font-size:28px;font-weight:700">-</div></div>
  </section>

  <section class="grid g2">
    <div>
      <h3 class="muted" style="margin:8px 0">Engines</h3>
      <div id="engines" class="list"></div>
    </div>
    <div>
      <h3 class="muted" style="margin:8px 0">Streams</h3>
      <div id="streams" class="list"></div>
    </div>
  </section>

  <section>
    <h3 class="muted" style="margin:8px 0">Stream detail</h3>
    <div id="detail" class="card">
      <div id="detail-meta" class="muted">Select a stream.</div>
      <div style="height:320px;margin-top:8px"><canvas id="chart"></canvas></div>
      <div id="detail-links" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="btn-stop" class="btn">Stop stream</button>
        <button id="btn-del" class="btn red">Delete engine</button>
      </div>
    </div>
  </section>

  <section id="errors" style="display:none" class="error"></section>

  <script>
    const $ = (s)=>document.querySelector(s);
    const orchInput = $('#orch');
    const keyInput = $('#apikey');
    const intervalSel = $('#interval');
    const statusEl = $('#status');
    const errEl = $('#errors');
    const kEng = $('#kpi-engines');
    const kStr = $('#kpi-streams');
    const kUpd = $('#kpi-upd');
    const engList = $('#engines');
    const strList = $('#streams');
    const detailMeta = $('#detail-meta');
    const detailLinks = $('#detail-links');
    const chartCtx = document.getElementById('chart');
    const btnStop = document.getElementById('btn-stop');
    const btnDel = document.getElementById('btn-del');

    let chart;
    let selectedStream = null;

    function loadPrefs(){
      const params = new URLSearchParams(location.search);
      orchInput.value = params.get('orch') || localStorage.getItem('orch_url') || 'http://localhost:8000';
      keyInput.value = localStorage.getItem('orch_apikey') || '';
    }
    function savePrefs(){
      localStorage.setItem('orch_url', orchInput.value.trim());
      localStorage.setItem('orch_apikey', keyInput.value.trim());
    }

    async function fetchJSON(url, opts={}){
      const headers = Object.assign({}, opts.headers || {});
      const key = (keyInput.value||'').trim();
      if (key) headers['Authorization'] = 'Bearer ' + key;
      const res = await fetch(url, Object.assign({}, opts, { headers }));
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    function showError(msg){ errEl.textContent = msg; errEl.style.display='block'; statusEl.textContent='error'; }
    function clearError(){ errEl.style.display='none'; statusEl.textContent='ok'; }

    function engineRow(e){
      const d = document.createElement('div');
      d.className = 'item';
      const left = document.createElement('div');
      left.innerHTML = `<div class="muted">${e.container_id.slice(0,12)}</div><div><strong>${e.host}:${e.port}</strong></div><div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">labels: ${Object.entries(e.labels||{}).map(([k,v])=>`${k}=${v}`).join(', ')}</div>`;
      const right = document.createElement('div');
      const del = document.createElement('button'); del.className='btn red'; del.textContent='Delete';
      del.onclick = async ()=>{
        try{ await fetchJSON(`${orchInput.value}/containers/${encodeURIComponent(e.container_id)}`, { method:'DELETE' }); await refreshAll(); } catch(err){ showError(err.message||String(err)); }
      };
      right.appendChild(del);
      d.appendChild(left); d.appendChild(right);
      d.onclick = async (ev)=>{ if(ev.target===del) return; await selectEngine(e); };
      return d;
    }

    function streamRow(s){
      const d = document.createElement('button');
      d.className = 'item';
      d.innerHTML = `<div><div><strong>${s.id}</strong></div><div class="muted">${s.key_type} · ${s.container_id.slice(0,12)}</div></div>`;
      d.onclick = ()=> selectStream(s);
      return d;
    }

    async function selectEngine(e){
      try{
        const data = await fetchJSON(`${orchInput.value}/engines/${encodeURIComponent(e.container_id)}`);
        renderStreams(data.streams||[]);
        if(data.streams && data.streams.length) selectStream(data.streams[0]);
      }catch(err){ showError(err.message||String(err)); }
    }

    async function selectStream(s){
      selectedStream = s;
      detailMeta.innerHTML = `<div class="row"><div><div class="muted">Stream</div><div><code>${s.id}</code></div></div><div><div class="muted">Session</div><div><code>${s.playback_session_id}</code></div></div></div>`+
        `<div class="row"><div><div class="muted">Key</div><div><code>${s.key}</code></div></div><div><div class="muted">Engine</div><div><code>${s.container_id}</code></div></div></div>`;
      detailLinks.innerHTML = `stat: <a href="${s.stat_url}" target="_blank">abrir</a> · cmd: <a href="${s.command_url}" target="_blank">abrir</a>`;
      await loadStatsAndDraw();
    }

    async function loadStatsAndDraw(){
      if(!selectedStream){ return; }
      try{
        const since = new Date(Date.now() - 60*60*1000).toISOString();
        const data = await fetchJSON(`${orchInput.value}/streams/${encodeURIComponent(selectedStream.id)}/stats?since=${encodeURIComponent(since)}`);
        const labels = data.map(x=> new Date(x.ts).toLocaleTimeString());
        const down = data.map(x=> x.speed_down);
        const up = data.map(x=> x.speed_up);
        const peers = data.map(x=> x.peers);
        if(chart){ chart.destroy(); }
        chart = new Chart(chartCtx, { type:'line', data:{ labels, datasets:[
          { label:'down kB/s', data:down, borderWidth:2, tension:.2 },
          { label:'up kB/s', data:up, borderWidth:2, tension:.2 },
          { label:'peers', data:peers, borderWidth:1, tension:.2 },
        ] }, options:{ responsive:true, scales:{ x:{ ticks:{ color:'#aaa' } }, y:{ ticks:{ color:'#aaa' } } }, plugins:{ legend:{ labels:{ color:'#ddd' } } } } });
      }catch(err){ /* ignore */ }
    }

    function renderEngines(arr){ engList.innerHTML=''; arr.forEach(e=> engList.appendChild(engineRow(e))); kEng.textContent = arr.length; }
    function renderStreams(arr){ strList.innerHTML=''; arr.forEach(s=> strList.appendChild(streamRow(s))); kStr.textContent = arr.length; }

    async function refreshAll(){
      clearError(); savePrefs();
      try{
        const [eng, str] = await Promise.all([
          fetchJSON(`${orchInput.value}/engines`),
          fetchJSON(`${orchInput.value}/streams?status=started`),
        ]);
        renderEngines(eng); renderStreams(str);
        kUpd.textContent = new Date().toLocaleTimeString();
        if(selectedStream){ await loadStatsAndDraw(); }
      }catch(err){ showError(err.message||String(err)); }
    }

    let timer;
    function restartTimer(){ if(timer) clearInterval(timer); timer = setInterval(refreshAll, Number(intervalSel.value||5000)); }

    btnStop.onclick = async ()=>{
      if(!selectedStream) return;
      try{
        const u = new URL(selectedStream.command_url);
        if(!u.searchParams.has('method')) u.searchParams.set('method','stop');
        await fetch(u.toString(), { method:'GET' });
      }catch(err){ showError('Stop failed: '+(err.message||String(err))); }
    };
    btnDel.onclick = async ()=>{
      if(!selectedStream) return;
      try{
        await fetchJSON(`${orchInput.value}/containers/${encodeURIComponent(selectedStream.container_id)}`, { method:'DELETE' });
        await refreshAll();
      }catch(err){ showError('Delete failed: '+(err.message||String(err))); }
    };

    loadPrefs(); refreshAll(); restartTimer();
    document.getElementById('refresh').onclick = refreshAll;
    intervalSel.onchange = restartTimer;
  </script>
</body>
</html>
